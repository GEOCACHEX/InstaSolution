<!DOCTYPE html>
<html>

<head>
	<script>

		const minLat = 54.50734476593547;
		const minLon = 18.545945167398138;
		const maxLat = 54.5088025841609;
		const maxLon = 18.549525607179877;

		// Replace alerts
		const realAlert = window.alert;
		let showedCameraError = false;
		window.alert = (error) => {
			let message = error.toString();

			if (message.includes('Webcam')) {
				message = showedCameraError ? null : `[PL] InstaSolution™ wymaga dostępu do kamery!\n[EN] InstaSolution™ requires access to the camera!`;
				showedCameraError = true;
			}

			if(message) {
				console.error(message);
				realAlert(message);
			}
		}

		let hasLocationPermission = false;
		document.addEventListener('DOMContentLoaded', () => {
			handleScenesLoading();
			handleSceneSwitching();
			requestGPS();
		});

		function onScenesReady() {
			handleGPS();
		}

		function handleScenesLoading() {
			let carSceneLoaded = false;
			let pathSceneLoaded = false;
			function checkIfBothScenesLoaded() {
				if (carSceneLoaded && pathSceneLoaded) {
					let interval = setInterval(checkReadiness, 100);
					function checkReadiness() {
						if (document.querySelector('#arjs-video') && hasLocationPermission) {
							clearInterval(interval);
							setTimeout(() => onScenesReady(), 500);
							setTimeout(() => parent.postMessage("apploaded", "*"), 1000);
						}
					}
				}
			}

			document.getElementById('car-scene').addEventListener('loaded', () => {
				carSceneLoaded = true;
				checkIfBothScenesLoaded();
			});

			document.getElementById('path-scene').addEventListener('loaded', () => {
				pathSceneLoaded = true;
				checkIfBothScenesLoaded();
			});
		}

		function requestGPS() {
			navigator.geolocation.getCurrentPosition(
				() => hasLocationPermission = true,
				() => window.alert('[PL] InstaSolution™ wymaga dostępu do Twojej lokalizacji!\n[EN] InstaSolution™ requires access your location!')
			);
		}

		function handleGPS() {
			navigator.geolocation.watchPosition(onLocationChange, () => {}, {
				enableHighAccuracy: true,
				maximumAge: 0
			});

			function onLocationChange(data) {

				// Error display
				const lat = data.coords.latitude;
				const lon = data.coords.longitude;
				const isOutside = lon > maxLon || lon < minLon || lat > maxLat || lat < minLat;
				document.getElementById('error-layer').style.display = isOutside ? 'flex' : 'none';

				// Hide distance arrows
				const objects = document.querySelectorAll("[gps-entity-place]");
				for (let object of objects) {
					const distance = object.getAttribute('distance');
					object.setAttribute('visible', distance < 25);
				}
			}
		}

		function handleSceneSwitching() {
			function switchScene(carScene) {
				let visibleAttribute = document.createAttribute('visible');
				visibleAttribute.value = carScene ? 'true' : 'false';
				document.getElementById('car-scene-root').setAttributeNode(visibleAttribute);

				visibleAttribute = document.createAttribute('visible');
				visibleAttribute.value = carScene ? 'false' : 'true'
				document.getElementById('path-scene-root').setAttributeNode(visibleAttribute);

				document.getElementById('car-scene').style.display = carScene ? 'block' : 'none';
				document.getElementById('path-scene').style.display = carScene ? 'none' : 'block';
			}
			switchScene(false);

			let markerLostTimeout;
			function clearLostTimeout() {
				if(markerLostTimeout) {
					clearTimeout(markerLostTimeout);
					markerLostTimeout = undefined;
				}
			}

			marker.addEventListener('markerFound', () => {
				clearLostTimeout();
				switchScene(true);
			});
			marker.addEventListener('markerLost', () => {
				clearLostTimeout();
				markerLostTimeout = setTimeout(() => switchScene(false), 500)
			});
		}


	</script>
	<style>
		a-scene {
			position: absolute;
			left: 0;
			right: 0;
			top: 0;
			bottom: 0;
			width: 100%;
			height: 100%;
		}
		body {
			margin : 0;
			overflow: hidden;
			font-family: Helvetica, sans-serif;
		}
		#logo {
			position: fixed;
			top: 10px;
			left: 10px;
			z-index: 99;
			border-radius: 10px;
			border: 3px solid #126524;
			box-shadow: 0px 0px 5px 1px #1c9962;
		}
		#error-layer {
			display: flex;
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			width: 100%;
			height: 100%;
			align-items: center;
			justify-content: center;
		}
		#location-error {
			color: #126524;
			display: inline-block;
			width: 80vw;
			z-index: 100;
			border-radius: 10px;
			border: 3px solid #126524;
			box-shadow: 0px 0px 5px 1px #1c9962;
			background-color: #e4fff4;
			padding: 10px;
		}
	</style>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

	<link rel="preload" as="image" href="logo.jpg">

	<link rel="preload" href="zuk/scene.bin" as="fetch">
	<link rel="preload" href="zuk/scene.gltf" as="fetch">
	<link rel="preload" as="image" href="zuk/textures/material_baseColor.jpeg">
	<link rel="preload" as="image" href="zuk/textures/material_emissive.jpeg">
	<link rel="preload" as="image" href="zuk/textures/material_metallicRoughness.jpg">
	<link rel="preload" as="image" href="zuk/textures/material_normal.jpeg">
	<link rel="preload" as="image" href="zuk/textures/shadow.png">
	<link rel="preload" as="image" href="zuk/textures/name.png">

	<link rel="preload" href="arrow/scene.bin" as="fetch">
	<link rel="preload" href="arrow/scene.gltf" as="fetch">

</head>
<body>

<div id="error-layer">
	<div id="location-error">
		[PL] Udaj się na lokalizację startową skrytki i użyj tam aplikacji GEOCACHEX® InstaSolution™ na telefonie.
		<br>
		[EN] Go to the cache starting location and use the GEOCACHEX® InstaSolution™ application on your phone there.
	</div>
</div>

<script src="aframe_1_2_0.min.js"></script>
<script src="aframe-ar_3_3_3.min.js"></script>

<!---->
<!---->
<!---->
<!--⚠️⚠️⚠️⚠️⚠️⚠️-->
<!--Zagadka jest na prawdę absuralnie prosta i przeglądanie tego kodu kompletnie niszczy Ci jakąkolwiek zabawę z podejmowania tego kesza. Przeglądając jedynie kod nie otworzysz pojemnika, na prawdę musisz odpalić appke na telefonie.-->
<!--⚠️⚠️⚠️⚠️⚠️⚠️-->
<!--The puzzle is really absurdly simple and browsing through this code completely destroys any fun of finding this cache. You won't open the container just by looking at the code, you really need to run this app on a phone.-->
<!--⚠️⚠️⚠️⚠️⚠️⚠️-->
<!---->
<!---->
<!---->

<img id="logo" src="logo.jpg" onclick="window.forceSimulated()">

<a-scene
		id="car-scene"
		loading-screen="enabled: false"
		shadow="type: pcf"
		renderer="logarithmicDepthBuffer: true;antialias: true;alpha: true"
		vr-mode-ui="enabled: false"
		embedded
		light="defaultLightsEnabled: false"
		arjs="detectionMode: mono_and_matrix; matrixCodeType: 4x4_BCH_13_9_3;"
>
	<a-assets>
		<img id="car-shadow" src="zuk/textures/shadow.png">
		<img id="car-name" src="zuk/textures/name.png">
		<a-asset-item id="car-model" src="zuk/scene.gltf"></a-asset-item>
	</a-assets>

	<a-entity id="car-scene-root">
		<a-entity light="type: ambient; color: #CCC; intensity: 4"></a-entity>
		<a-entity light="type: directional; color: #CFC; intensity: 4" position="-1.5 1.0 1.0"></a-entity>
		<a-entity light="type: directional; color: #FCC; intensity: 4" position="1.5 1.1 -1.0"></a-entity>
		<a-marker id="marker" type="barcode" value="69">
			<a-entity
					position="0 0.75 0"
					scale="4 4 4"
					gltf-model="#car-model"
			></a-entity>
			<a-image src="#car-shadow" rotation="90 0 0" position="0 0.126 0" scale="3.5 6.5 3"></a-image>
			<a-image src="#car-name" position="0 0 3.31" height="0.24" width="2.7"></a-image>
			<a-box color="#050505" depth="6.6" height="0.25" width="3"></a-box>

		</a-marker>
	</a-entity>
	<a-entity camera id="car-scene-camera"></a-entity>

</a-scene>

<a-scene
		id="path-scene"
		loading-screen="enabled: false"
		shadow="type: pcf"
		renderer="logarithmicDepthBuffer: true;antialias: true"
		vr-mode-ui="enabled: false"
		embedded
		light="defaultLightsEnabled: false"
		arjs="sourceType: webcam;"
>
	<a-assets>
		<a-asset-item id="arrow-model" src="arrow/scene.gltf"></a-asset-item>
	</a-assets>

	<a-entity id="path-scene-root">
		<a-entity light="type: ambient; color: #CCC; intensity: 2"></a-entity>
		<a-entity light="type: directional; color: #FFF; intensity: 1" position="-1.5 1.0 1.0"></a-entity>
		<a-entity gps-entity-place='latitude: 54.50766; longitude: 18.54696' rotation="0 -145 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.50772; longitude: 18.54712' rotation="0 -145 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.50778; longitude: 18.54727?' rotation="0 -145 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.50785; longitude: 18.54747' rotation="0 -145 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>

		<a-entity gps-entity-place='latitude: 54.50794; longitude: 18.54771' rotation="0 -195 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>

		<a-entity gps-entity-place='latitude: 54.50793; longitude: 18.54786' rotation="0 -195 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.50790; longitude: 18.54805' rotation="0 -195 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.50789; longitude: 18.54817' rotation="0 -195 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.50787; longitude: 18.54832' rotation="0 -195 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.50785; longitude: 18.54849' rotation="0 -195 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>

		<a-entity gps-entity-place='latitude: 54.50783; longitude: 18.54864' rotation="0 -102 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>

		<a-entity gps-entity-place='latitude: 54.50788; longitude: 18.54866' rotation="0 -102 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.50793; longitude: 18.54868' rotation="0 -102 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>

		<a-entity gps-entity-place='latitude: 54.50799; longitude: 18.54871' rotation="0 -51 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>

		<a-entity gps-entity-place='latitude: 54.50803; longitude: 18.54866' rotation="0 -26 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>

		<a-entity gps-entity-place='latitude: 54.50806981598308; longitude: 18.54852380290372' rotation="0 -26 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.50810655784916; longitude: 18.548399023958908' rotation="0 -26 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.50813634564967; longitude: 18.548301497634252' rotation="0 -26 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>

		<a-entity gps-entity-place='latitude: 54.508182007045995; longitude: 18.548148635754195' rotation="0 -32 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.50822153605354; longitude: 18.54803517686324' rotation="0 -52 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.50828100053982; longitude: 18.547958027238735' rotation="0 -52 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.508332983969574; longitude: 18.54789772045014' rotation="0 44 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.508288862206015; longitude: 18.547820343499023' rotation="0 75 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.50819780362947; longitude: 18.547776362892435' rotation="0 -14 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.508215079785764; longitude: 18.54763295205499' rotation="0 -34 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.50824599002694; longitude: 18.547552879349308' rotation="0 -15 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.50826356527205; longitude: 18.547439664804354' rotation="0 -15 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.50828055392233; longitude: 18.547340933503765' rotation="0 -15 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.5082906442317; longitude: 18.54724228552386' rotation="0 -106 90" scale="0.003 0.003 0.005" gltf-model="#arrow-model"></a-entity>
	</a-entity>

	<a-camera wasd-controls-enabled="true" gps-camera="gpsMinDistance: 0" rotation-reader id="path-scene-camera"></a-camera>


</a-scene>

</body>
</html>
