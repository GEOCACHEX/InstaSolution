<!DOCTYPE html>
<html>

<head>
	<script>

		// Measuring
		let measures = [];
		let heading = 0;


		window.addEventListener("deviceorientationabsolute", (e) => heading = e.webkitCompassHeading || Math.abs(e.alpha - 360), true);
		window.addMeasure = () => {
			navigator.geolocation.getCurrentPosition(
				(data) => {
					console.log(data);
					const lat = data.coords.latitude;
					const lon = data.coords.longitude;
					const alt = data.coords.altitude;
					const acc = data.coords.accuracy;
					const head = -(heading - 270);
					const obj = { lat, lon, alt, head, acc };
					measures.push(obj);
					navigator.clipboard.writeText(JSON.stringify(measures, null, 0)).then(() => window.alert(JSON.stringify(obj, null, 0)));
				},
				(d) => {
					window.alert('Failed to add');
					console.log(d);
				},
				{
					enableHighAccuracy: true,
					maximumAge: 0
				}
			);
		}

		// Replace alerts
		const realAlert = window.alert;
		let showedCameraError = false;
		window.alert = (error) => {
			let message = error.toString();

			if (message.includes('Webcam')) {
				message = showedCameraError ? null : `[PL] InstaSolution™ wymaga dostępu do kamery!\n[EN] InstaSolution™ requires access to the camera!`;
				showedCameraError = true;
			}

			if(message) {
				console.error(message);
				realAlert(message);
			}
		}

		let hasLocationPermission = false;
		let domContentLoaded = false;
		let area = undefined;

		window.fetch('elevation.json').then(response => response.json()).then(data => {
			elevationsLoaded = true;
			area = data;
			tryToInit();
		})

		document.addEventListener('DOMContentLoaded', () => {
			domContentLoaded = true;
			tryToInit();
		});

		function tryToInit() {
			if (domContentLoaded && area) init();
		}

		async function init() {
			handleScenesLoading();
			handleSceneSwitching();
			requestGPS();
		}

		function onScenesReady() {
			moveObjectsBasedOnElevation();
			handleGPS();
		}

		function getVertexHeight(lat, lon) {
			return area.elevations[lat * (area.stepsLon + 1) + lon];
		}

		function moveObjectsBasedOnElevation() {
			const objects = document.querySelectorAll("[gps-entity-place]");

			for (let object of objects) {
				const position = object.getAttribute('position');
				const coords = object.getAttribute('gps-entity-place');
				const height = getHeight(coords.latitude, coords.longitude);
				object.setAttribute('position', {
					x: position.x,
					y: position.y + height,
					z: position.z
				});
			}
		}

		function getHeight(lat, lon) {
			const localLat = Math.min(Math.max(lat, area.minLat), area.maxLat - area.stepLat / 1000) - area.minLat;
			const localLon = Math.min(Math.max(lon, area.minLon), area.maxLon - area.stepLon / 1000) - area.minLon;
			let stepLat = localLat / area.stepLat;
			let stepLon = localLon / area.stepLon;
			const fractionLat = stepLat % 1;
			const fractionLon = stepLon % 1;
			stepLat = Math.floor(stepLat);
			stepLon = Math.floor(stepLon);
			h00 = getVertexHeight(stepLat, stepLon);
			h10 = getVertexHeight(stepLat + 1, stepLon);
			h01 = getVertexHeight(stepLat, stepLon + 1);
			h11 = getVertexHeight(stepLat + 1, stepLon + 1);
			h0 = h00 + (h10 - h00) * fractionLat;
			h1 = h01 + (h11 - h01) * fractionLat;
			h = h0 + (h1 - h0) * fractionLon;
			return h;
		}

		function handleScenesLoading() {
			let carSceneLoaded = false;
			let pathSceneLoaded = false;
			function checkIfBothScenesLoaded() {
				if (carSceneLoaded && pathSceneLoaded) {
					let interval = setInterval(checkReadiness, 100);
					function checkReadiness() {
						if (document.querySelector('#arjs-video') && hasLocationPermission) {
							clearInterval(interval);
							setTimeout(() => onScenesReady(), 500);
							setTimeout(() => parent.postMessage("apploaded", "*"), 1000);
						}
					}
				}
			}

			document.getElementById('car-scene').addEventListener('loaded', () => {
				carSceneLoaded = true;
				checkIfBothScenesLoaded();
			});

			document.getElementById('path-scene').addEventListener('loaded', () => {
				pathSceneLoaded = true;
				checkIfBothScenesLoaded();
			});
		}

		function requestGPS() {
			navigator.geolocation.getCurrentPosition(
				() => hasLocationPermission = true,
				() => window.alert('[PL] InstaSolution™ wymaga dostępu do Twojej lokalizacji!\n[EN] InstaSolution™ requires access your location!')
			);
		}

		function handleGPS() {
			navigator.geolocation.watchPosition(onLocationChange, () => {}, {
				enableHighAccuracy: true,
				maximumAge: 0
			});

			function onLocationChange(data) {
				const lat = data.coords.latitude;
				const lon = data.coords.longitude;
				const isOutside = lon > area.maxLon || lon < area.minLon || lat > area.maxLat || lat < area.minLat;
				document.getElementById('error-layer').style.display = isOutside ? 'flex' : 'none';
				const height = getHeight(lat, lon);
				const camera = document.querySelector('[gps-camera]');
				camera.setAttribute('position', {
					x: 0,
					y: height + 1.6,
					z: 0
				});

				console.log(data.coords);
			}
		}

		function handleSceneSwitching() {
			function switchScene(carScene) {
				let visibleAttribute = document.createAttribute('visible');
				visibleAttribute.value = carScene ? 'true' : 'false';
				document.getElementById('car-scene-root').setAttributeNode(visibleAttribute);

				visibleAttribute = document.createAttribute('visible');
				visibleAttribute.value = carScene ? 'false' : 'true'
				document.getElementById('path-scene-root').setAttributeNode(visibleAttribute);

				document.getElementById('car-scene').style.display = carScene ? 'block' : 'none';
				document.getElementById('path-scene').style.display = carScene ? 'none' : 'block';
			}
			switchScene(false);

			let markerLostTimeout;
			function clearLostTimeout() {
				if(markerLostTimeout) {
					clearTimeout(markerLostTimeout);
					markerLostTimeout = undefined;
				}
			}

			marker.addEventListener('markerFound', () => {
				clearLostTimeout();
				switchScene(true);
			});
			marker.addEventListener('markerLost', () => {
				clearLostTimeout();
				markerLostTimeout = setTimeout(() => switchScene(false), 500)
			});
		}


	</script>
	<style>
		a-scene {
			position: absolute;
			left: 0;
			right: 0;
			top: 0;
			bottom: 0;
			width: 100%;
			height: 100%;
		}
		body {
			margin : 0;
			overflow: hidden;
			font-family: Helvetica, sans-serif;
		}
		#logo {
			position: fixed;
			top: 10px;
			left: 10px;
			z-index: 99;
			border-radius: 10px;
			border: 3px solid #126524;
			box-shadow: 0px 0px 5px 1px #1c9962;
		}
		#error-layer {
			display: flex;
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			width: 100%;
			height: 100%;
			align-items: center;
			justify-content: center;
		}
		#location-error {
			color: #126524;
			display: inline-block;
			width: 80vw;
			z-index: 100;
			border-radius: 10px;
			border: 3px solid #126524;
			box-shadow: 0px 0px 5px 1px #1c9962;
			background-color: #e4fff4;
			padding: 10px;
		}
	</style>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

	<link rel="preload" as="image" href="logo.jpg">

	<link rel="preload" href="zuk/scene.bin" as="fetch">
	<link rel="preload" href="zuk/scene.gltf" as="fetch">
	<link rel="preload" as="image" href="zuk/textures/material_baseColor.jpeg">
	<link rel="preload" as="image" href="zuk/textures/material_emissive.jpeg">
	<link rel="preload" as="image" href="zuk/textures/material_metallicRoughness.jpg">
	<link rel="preload" as="image" href="zuk/textures/material_normal.jpeg">
	<link rel="preload" as="image" href="zuk/textures/shadow.png">
	<link rel="preload" as="image" href="zuk/textures/name.png">

	<link rel="preload" href="arrow/scene.bin" as="fetch">
	<link rel="preload" href="arrow/scene.gltf" as="fetch">

</head>
<body>

<div id="error-layer">
	<div id="location-error">
		[PL] Udaj się na lokalizację startową skrytki i użyj tam aplikacji GEOCACHEX® InstaSolution™ na telefonie.
		<br>
		[EN] Go to the cache starting location and use the GEOCACHEX® InstaSolution™ application on your phone there.
	</div>
</div>

<script src="aframe_1_2_0.min.js"></script>
<script src="aframe-ar_3_3_3.min.js"></script>

<!---->
<!---->
<!---->
<!--⚠️⚠️⚠️⚠️⚠️⚠️-->
<!--Zagadka jest na prawdę absuralnie prosta i przeglądanie tego kodu kompletnie niszczy Ci jakąkolwiek zabawę z podejmowania tego kesza. Przeglądając jedynie kod nie otworzysz pojemnika, na prawdę musisz odpalić appke na telefonie.-->
<!--⚠️⚠️⚠️⚠️⚠️⚠️-->
<!--The puzzle is really absurdly simple and browsing through this code completely destroys any fun of finding this cache. You won't open the container just by looking at the code, you really need to run this app on a phone.-->
<!--⚠️⚠️⚠️⚠️⚠️⚠️-->
<!---->
<!---->
<!---->

<img id="logo" src="logo.jpg" onclick="window.addMeasure()">

<a-scene
		id="car-scene"
		loading-screen="enabled: false"
		shadow="type: pcf"
		renderer="logarithmicDepthBuffer: true;antialias: true;alpha: true"
		vr-mode-ui="enabled: false"
		embedded
		light="defaultLightsEnabled: false"
		arjs="detectionMode: mono_and_matrix; matrixCodeType: 4x4_BCH_13_9_3;"
>
	<a-assets>
		<img id="car-shadow" src="zuk/textures/shadow.png">
		<img id="car-name" src="zuk/textures/name.png">
		<a-asset-item id="car-model" src="zuk/scene.gltf"></a-asset-item>
	</a-assets>

	<a-entity id="car-scene-root">
		<a-entity light="type: ambient; color: #CCC; intensity: 4"></a-entity>
		<a-entity light="type: directional; color: #CFC; intensity: 4" position="-1.5 1.0 1.0"></a-entity>
		<a-entity light="type: directional; color: #FCC; intensity: 4" position="1.5 1.1 -1.0"></a-entity>
		<a-marker id="marker" type="barcode" value="69">
			<a-entity
					position="0 0.75 0"
					scale="4 4 4"
					gltf-model="#car-model"
			></a-entity>
			<a-image src="#car-shadow" rotation="90 0 0" position="0 0.126 0" scale="3.5 6.5 3"></a-image>
			<a-image src="#car-name" position="0 0 3.31" height="0.24" width="2.7"></a-image>
			<a-box color="#050505" depth="6.6" height="0.25" width="3"></a-box>

		</a-marker>
	</a-entity>
	<a-entity camera id="car-scene-camera"></a-entity>

</a-scene>

<a-scene
		id="path-scene"
		loading-screen="enabled: false"
		shadow="type: pcf"
		renderer="logarithmicDepthBuffer: true;antialias: true"
		vr-mode-ui="enabled: false"
		embedded
		light="defaultLightsEnabled: false"
		arjs="sourceType: webcam;"
>
	<a-assets>
		<a-asset-item id="arrow-model" src="arrow/scene.gltf"></a-asset-item>
	</a-assets>

	<a-entity id="path-scene-root">
		<a-entity light="type: ambient; color: #CCC; intensity: 2"></a-entity>
		<a-entity light="type: directional; color: #CFC; intensity: 4" position="-1.5 1.0 1.0"></a-entity>
		<a-entity light="type: directional; color: #FCC; intensity: 4" position="1.5 1.1 -1.0"></a-entity>
		<a-entity gps-entity-place='latitude: 54.50822784; longitude: 18.54727361' rotation="0 -86 90" scale="0.005 0.005 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.50817661; longitude: 18.54755617' rotation="0 -17 90" scale="0.005 0.005 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.50821566; longitude: 18.54782801' rotation="0 -12 90" scale="0.005 0.005 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.50827985; longitude: 18.54791904' rotation="0 58 90" scale="0.005 0.005 0.005" gltf-model="#arrow-model"></a-entity>

		<a-entity gps-entity-place='latitude: 54.5081995; longitude: 18.5481069' rotation="0 -33 90" scale="0.005 0.005 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.5081593; longitude: 18.5482806' rotation="0 -23 90" scale="0.005 0.005 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.5080992; longitude: 18.548565' rotation="0 -23 90" scale="0.005 0.005 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.5080548; longitude: 18.5486562' rotation="0 -14 90" scale="0.005 0.005 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.5078249; longitude: 18.5485687' rotation="0 264 90" scale="0.005 0.005 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.5079179; longitude: 18.5484408' rotation="0 188 90" scale="0.005 0.005 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.5079793; longitude: 18.5480102' rotation="0 176 90" scale="0.005 0.005 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.5079959; longitude: 18.5477267' rotation="0 173 90" scale="0.005 0.005 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.5079531; longitude: 18.5474787' rotation="0 219 90" scale="0.005 0.005 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.5078088; longitude: 18.5473201' rotation="0 219 90" scale="0.005 0.005 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.5077978; longitude: 18.5471903' rotation="0 226 90" scale="0.005 0.005 0.005" gltf-model="#arrow-model"></a-entity>
		<a-entity gps-entity-place='latitude: 54.5077278; longitude: 18.5469842' rotation="0 224 90" scale="0.005 0.005 0.005" gltf-model="#arrow-model"></a-entity>
	</a-entity>

	<a-camera gps-camera rotation-reader id="path-scene-camera"></a-camera>


</a-scene>

</body>
</html>
